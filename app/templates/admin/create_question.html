{% extends "base.html" %}
{% block title %}Add Question - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="display-5">Add Question to "{{ quiz.title }}"</h1>
        </div>
    </div>

    {% include "includes/flash_messages.html" %}

    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.create_question', quiz_id=quiz.id) }}">
                        {{ form.csrf_token }}

                        <div class="mb-3">
                            <label for="{{ form.text.id }}" class="form-label">{{ form.text.label.text }} <span
                                    class="text-danger">*</span></label>
                            {{ form.text(class="form-control bg-dark text-white", rows=3, placeholder="Enter question
                            text") }}
                            {% if form.text.errors %}
                            <div class="text-danger">
                                {% for error in form.text.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.difficulty_level.id }}" class="form-label">{{
                                form.difficulty_level.label.text }} <span class="text-danger">*</span></label>
                            {{ form.difficulty_level(class="form-select bg-dark text-white") }}
                            {% if form.difficulty_level.errors %}
                            <div class="text-danger">
                                {% for error in form.difficulty_level.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <h5>Answer Options <span class="text-danger">*</span></h5>
                        <p class="text-muted small">Add at least 2 answer options and mark at least one as correct.</p>

                        <div id="answers-container">
                            <!-- Answer option rows will be added here dynamically -->
                            <div class="answer-row row mb-3">
                                <div class="col-md-9">
                                    <input type="text" name="answer_text[]" class="form-control bg-dark text-white"
                                        placeholder="Answer option 1" required>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check">
                                        <input class="form-check-input answer-correct-input" type="checkbox"
                                            name="is_correct_checkbox[]" value="1" onchange="updateCorrectAnswers()">
                                        <input type="hidden" name="is_correct[]" value="0" class="answer-correct-value">
                                        <label class="form-check-label">Correct Answer</label>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-answer" disabled>
                                        <i class="fas fa-minus-circle"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="answer-row row mb-3">
                                <div class="col-md-9">
                                    <input type="text" name="answer_text[]" class="form-control bg-dark text-white"
                                        placeholder="Answer option 2" required>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check">
                                        <input class="form-check-input answer-correct-input" type="checkbox"
                                            name="is_correct_checkbox[]" value="1" onchange="updateCorrectAnswers()">
                                        <input type="hidden" name="is_correct[]" value="0" class="answer-correct-value">
                                        <label class="form-check-label">Correct Answer</label>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-answer" disabled>
                                        <i class="fas fa-minus-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <button type="button" id="add-answer" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-plus-circle"></i> Add Another Answer Option
                            </button>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle"></i> Add Question
                            </button>
                            <a href="{{ url_for('admin.quiz_questions', quiz_id=quiz.id) }}"
                                class="btn btn-outline-secondary">
                                <i class="fas fa-times-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const answersContainer = document.getElementById('answers-container');
        const addAnswerBtn = document.getElementById('add-answer');

        // Enable remove buttons if we have more than 2 answers
        updateRemoveButtons();

        // Add answer option
        addAnswerBtn.addEventListener('click', function () {
            const answerCount = document.querySelectorAll('.answer-row').length + 1;

            const newRow = document.createElement('div');
            newRow.className = 'answer-row row mb-3';
            newRow.innerHTML = `
                <div class="col-md-9">
                    <input type="text" name="answer_text[]" class="form-control bg-dark text-white" placeholder="Answer option ${answerCount}" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input answer-correct-input" type="checkbox" name="is_correct_checkbox[]" value="1" onchange="updateCorrectAnswers()">
                        <input type="hidden" name="is_correct[]" value="0" class="answer-correct-value">
                        <label class="form-check-label">Correct Answer</label>
                    </div>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-answer">
                        <i class="fas fa-minus-circle"></i>
                    </button>
                </div>
            `;

            answersContainer.appendChild(newRow);
            updateRemoveButtons();

            // Add event listener to new remove button
            newRow.querySelector('.remove-answer').addEventListener('click', function () {
                newRow.remove();
                updateRemoveButtons();
            });
        });

        // Add event listeners to existing remove buttons
        document.querySelectorAll('.remove-answer').forEach(button => {
            button.addEventListener('click', function () {
                this.closest('.answer-row').remove();
                updateRemoveButtons();
            });
        });
    });

    // Update which remove buttons should be enabled
    function updateRemoveButtons() {
        const answerRows = document.querySelectorAll('.answer-row');
        const removeButtons = document.querySelectorAll('.remove-answer');

        removeButtons.forEach(button => {
            button.disabled = answerRows.length <= 2;
        });
    }

    // Update hidden values for correct answers
    function updateCorrectAnswers() {
        const checkboxes = document.querySelectorAll('.answer-correct-input');
        const hiddenInputs = document.querySelectorAll('.answer-correct-value');

        checkboxes.forEach((checkbox, index) => {
            hiddenInputs[index].value = checkbox.checked ? '1' : '0';
        });
    }
</script>
{% endblock %}