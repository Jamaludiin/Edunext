{% extends 'base.html' %}

{% block title %}Quiz History - Learning Assistant{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5">Quiz History</h1>
        <a href="{{ url_for('dashboard.student_quizzes') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Quizzes
        </a>
    </div>

    {% include "includes/flash_messages.html" %}

    {% if attempts %}
    <div class="card bg-dark text-white mb-4">
        <div class="card-header">
            <h5 class="mb-0">Your Quiz Attempts</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Quiz</th>
                        <th>Subject</th>
                        <th>Date</th>
                        <th>Score</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attempt in attempts %}
                    <tr>
                        <td>{{ attempt.quiz.title }}</td>
                        <td>
                            <span class="badge bg-info">{{ attempt.quiz.subject.code }}</span>
                        </td>
                        <td>{{ attempt.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if attempt.score is not none %}
                            <span class="badge 
                                    {% if attempt.score >= 80 %}bg-success
                                    {% elif attempt.score >= 60 %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                {{ attempt.score|round(1) }}%
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">Incomplete</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if attempt.end_time %}
                            {{ ((attempt.end_time - attempt.start_time).total_seconds() / 60)|round(1) }} min
                            {% else %}
                            <span class="badge bg-warning">In progress</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if attempt.end_time %}
                            <a href="{{ url_for('dashboard.quiz_results', attempt_id=attempt.id) }}"
                                class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i> View Results
                            </a>
                            {% else %}
                            <a href="{{ url_for('dashboard.take_quiz', attempt_id=attempt.id) }}"
                                class="btn btn-sm btn-warning">
                                <i class="fas fa-play"></i> Resume
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quiz Statistics -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card bg-dark text-white">
                <div class="card-header">Total Attempts</div>
                <div class="card-body text-center">
                    <h3>{{ attempts|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card bg-dark text-white">
                <div class="card-header">Average Score</div>
                <div class="card-body text-center">
                    {% set valid_scores = [] %}
                    {% for attempt in attempts %}
                        {% if attempt.score is not none %}
                            {% set _ = valid_scores.append(attempt) %}
                        {% endif %}
                    {% endfor %}
                    <h3>
                        {% if valid_scores|length > 0 %}
                            {{ (valid_scores|sum(attribute='score') / valid_scores|length)|round(1) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card bg-dark text-white">
                <div class="card-header">Subjects Tested</div>
                <div class="card-body text-center">
                    <h3>{{ attempts|map(attribute='quiz.subject_id')|unique|list|length }}</h3>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <h4 class="alert-heading">No Quiz History</h4>
        <p>You haven't attempted any quizzes yet. Start by taking a quiz from your available courses.</p>
        <a href="{{ url_for('dashboard.student_quizzes') }}" class="btn btn-primary mt-2">
            <i class="fas fa-play"></i> Take a Quiz
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}