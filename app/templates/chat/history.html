{% extends 'base.html' %}

{% block title %}Chat History{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .history-container {
        min-height: calc(100vh - 200px);
    }

    .conversation-card {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
        margin-bottom: 1rem;
    }

    .conversation-card:hover {
        border-left-color: #007bff;
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .conversation-timestamp {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .conversation-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .conversation-snippet {
        font-size: 0.9rem;
        color: #666;
    }

    .conversation-subject {
        font-size: 0.8rem;
        background-color: #e9ecef;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        margin-right: 0.5rem;
    }

    .empty-history {
        text-align: center;
        padding: 3rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }

    .empty-history i {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 history-container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Chat History</h2>
            <p class="text-muted">Your previous conversations with the AI assistant</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('chat.chat_interface') }}" class="btn btn-primary">
                <i class="fas fa-comment"></i> New Conversation
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12" id="history-container">
            <!-- Content will be loaded dynamically -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading your conversations...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const historyContainer = document.getElementById('history-container');

        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Load chat history
        fetch('/chat/history')
            .then(response => response.json())
            .then(data => {
                historyContainer.innerHTML = ''; // Clear loading spinner

                if (data.success) {
                    if (data.history && data.history.length > 0) {
                        data.history.forEach(conversation => {
                            const card = document.createElement('div');
                            card.className = 'card conversation-card';

                            // Prepare subject badge if available
                            let subjectBadge = '';
                            if (conversation.subject) {
                                subjectBadge = `<span class="conversation-subject">${conversation.subject}</span>`;
                            }

                            card.innerHTML = `
                                <div class="card-body">
                                    <div class="conversation-header">
                                        <div class="d-flex align-items-center">
                                            ${subjectBadge}
                                            <span class="conversation-timestamp">
                                                <i class="far fa-clock me-1"></i>${formatDate(conversation.timestamp)}
                                            </span>
                                        </div>
                                        <a href="/chat/conversation/${conversation.conversation_id}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-arrow-right"></i> Continue
                                        </a>
                                    </div>
                                    <h5 class="conversation-title">${conversation.title}</h5>
                                    <div class="conversation-snippet">
                                        <div><strong>You:</strong> ${conversation.snippet.question}</div>
                                        <div><strong>AI:</strong> ${conversation.snippet.answer}</div>
                                    </div>
                                </div>
                            `;

                            // Add click handler to navigate to conversation
                            card.addEventListener('click', function (e) {
                                // Don't trigger if clicking on the Continue button
                                if (!e.target.closest('.btn')) {
                                    window.location.href = `/chat/conversation/${conversation.conversation_id}`;
                                }
                            });

                            historyContainer.appendChild(card);
                        });
                    } else {
                        // Show empty state
                        historyContainer.innerHTML = `
                            <div class="empty-history">
                                <i class="far fa-comment-dots"></i>
                                <h4>No conversations yet</h4>
                                <p>Start chatting with the AI assistant to see your history here.</p>
                                <a href="${window.location.origin}/chat" class="btn btn-primary">
                                    <i class="fas fa-comment"></i> Start a conversation
                                </a>
                            </div>
                        `;
                    }
                } else {
                    // Show error
                    historyContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading chat history: ${data.error || 'Unknown error'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                historyContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error: ${error.message || 'Failed to load chat history'}
                    </div>
                `;
            });
    });
</script>
{% endblock %}