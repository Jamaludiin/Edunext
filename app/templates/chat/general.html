{% extends 'base.html' %}

{% block title %}General Chat{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .chat-container {
        height: calc(100vh - 210px);
        display: flex;
        flex-direction: column;
        background-color: var(--bg-dark);
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-header {
        background-color: rgba(0, 123, 255, 0.2);
        color: white;
        padding: 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-header .new-conversation-btn {
        background-color: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .chat-header .new-conversation-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: var(--bg-dark);
    }

    .message {
        margin-bottom: 15px;
        display: flex;
    }

    .user-message {
        justify-content: flex-end;
    }

    .bot-message {
        justify-content: flex-start;
    }

    .message-content {
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 70%;
        white-space: pre-wrap;
        /* Ensure line breaks are respected */
    }

    .user-message .message-content {
        background-color: #007bff;
        color: white;
        border-top-right-radius: 0;
    }

    .bot-message .message-content {
        background-color: var(--bg-darker);
        color: rgba(255, 255, 255, 0.9);
        border-top-left-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-input {
        display: flex;
        align-items: center;
        padding: 15px;
        background-color: var(--bg-darker);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-input .input-group {
        flex: 1;
        display: flex;
    }

    /* Input field takes full width */
    .chat-input input#user-input {
        border-radius: 20px 0 0 20px !important;
    }

    .chat-input button#send-button {
        border-radius: 0 20px 20px 0 !important;
        flex-shrink: 0;
    }

    .context-panel {
        height: calc(100vh - 210px);
        background-color: var(--bg-darker);
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        padding: 15px;
        overflow-y: auto;
        color: rgba(255, 255, 255, 0.9);
    }

    .context-item {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
        word-wrap: break-word;
        /* Break long words */
    }

    .context-source {
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--primary-color);
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
    }

    .loading-dots {
        display: flex;
    }

    .loading-dots span {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin: 0 3px;
        background-color: #007bff;
        border-radius: 50%;
        animation: loading 1.4s ease-in-out infinite;
    }

    .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes loading {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-9">
            <div class="chat-container" id="main-chat-container" data-initial='{{ initial_data | tojson | safe }}'>
                <div class="chat-header">
                    <span class="fs-5 fw-bold">General Chat</span>
                    <button id="new-conversation-btn" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> New Conversation
                    </button>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message bot-message">
                        <div class="message-content">
                            <span id="system-welcome-message">Hello! I'm the general AI Assistant. I can answer
                                questions based on the university's shared knowledge base. How can I help you
                                today?</span>
                        </div>
                    </div>
                </div>

                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" id="user-input" placeholder="Ask a question based on general knowledge..."
                            class="form-control">

                        <!-- Upload button next to send button -->
                        <button type="button" id="upload-pdf-btn" class="btn btn-secondary no-radius"
                            style="border-radius: 0 !important;" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Upload PDF for personalized answers">
                            <i class="fas fa-file-upload"></i>
                        </button>

                        <button id="send-button" class="btn btn-primary"
                            style="border-radius: 0 20px 20px 0 !important;">
                            <i class="fas fa-paper-plane"></i>
                        </button>

                        <input type="file" id="pdf-upload-input" accept=".pdf" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="context-panel">
                <h5 class="text-white mb-3">Source Context</h5>
                <div class="alert alert-info bg-dark text-white border border-info">
                    <i class="fas fa-info-circle me-2"></i> When I answer your questions, I'll show the source material I used here.
                </div>
                <div id="context-container"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatContainer = document.getElementById('main-chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const contextContainer = document.getElementById('context-container');
        const uploadPdfBtn = document.getElementById('upload-pdf-btn');
        const pdfUploadInput = document.getElementById('pdf-upload-input');
        const newConversationBtn = document.getElementById('new-conversation-btn');

        // Retrieve and parse initial data from data attribute
        let initialData = {};
        let currentConversationId = null;
        let initialMessages = [];
        try {
            initialData = JSON.parse(chatContainer.dataset.initial || '{}');
            currentConversationId = initialData.conversation_id || null;
            initialMessages = initialData.messages || [];
            if (!Array.isArray(initialMessages)) {
                initialMessages = []; // Ensure it's an array
            }

            // Update welcome message if provided
            if (initialData.system_message) {
                document.getElementById('system-welcome-message').innerText = initialData.system_message;
            }

            // Show warning if provided
            if (initialData.warning_message) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mb-3';
                warningDiv.innerText = initialData.warning_message;
                chatMessages.appendChild(warningDiv);
            }

            // Disable input if vector DB is not ready
            if (initialData.vector_db_ready === false) {
                userInput.disabled = true;
                userInput.placeholder = "No knowledge base is available. Please upload documents or contact an administrator.";
                sendButton.disabled = true;

                // Keep upload button enabled for students
                document.getElementById('upload-pdf-btn').disabled = false;
            }
        } catch (e) {
            console.error('Error parsing initial data:', e);
            currentConversationId = null;
            initialMessages = [];
        }

        // Initialize chat with existing messages if available
        function initializeChat() {
            if (initialMessages && initialMessages.length > 0) {
                // Clear the default welcome message
                chatMessages.innerHTML = '';

                // Add conversation header if we have a conversation ID
                if (currentConversationId) {
                    const headerDiv = document.createElement('div');
                    headerDiv.id = 'conversation-header';
                    headerDiv.className = 'alert alert-light d-flex justify-content-between align-items-center mb-3';

                    const conversationInfo = document.createElement('div');
                    conversationInfo.innerHTML = `<small>Continuing conversation #${currentConversationId} (General)</small>`;

                    const historyLink = document.createElement('a');
                    // Note: History link might show all conversations, filtering could be added later
                    historyLink.href = '{{ url_for("chat.general_chat_history_view") }}';
                    historyLink.className = 'btn btn-sm btn-outline-secondary';
                    historyLink.innerHTML = '<i class="fas fa-history"></i> View History';

                    headerDiv.appendChild(conversationInfo);
                    headerDiv.appendChild(historyLink);
                    chatMessages.appendChild(headerDiv);
                }

                // Add previous messages from the parsed JSON
                initialMessages.forEach((message, index) => {
                    addMessage(message.content, message.sender);

                    // Show context for the last AI message
                    if (index === initialMessages.length - 1 && message.sender === 'ai' && message.context && message.context.length > 0) {
                        displayContext(message.context, message.context_type || 'base');
                    }
                });

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Function to add a message to the chat
        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerText = message; // Use innerText for security

            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to show loading indicator
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading-indicator';

            const loadingDots = document.createElement('div');
            loadingDots.className = 'loading-dots';

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                loadingDots.appendChild(dot);
            }

            loadingDiv.appendChild(loadingDots);
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to hide loading indicator
        function hideLoading() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        // Function to display context
        function displayContext(context, contextType = 'base') {
            contextContainer.innerHTML = ''; // Clear previous context

            if (!context || context.length === 0) {
                const noContext = document.createElement('div');
                noContext.className = 'alert alert-warning';
                noContext.innerText = 'No specific context was used for this response.';
                contextContainer.appendChild(noContext);
                return;
            }

            // Add context type info based on the source
            const dbTypeInfo = document.createElement('div');
            dbTypeInfo.className = 'alert alert-secondary mb-2';

            // Display different source text based on context type
            let sourceText = 'General Knowledge';
            if (contextType === 'student') {
                sourceText = 'Your Uploaded Documents + General Knowledge';
            } else if (contextType === 'subject') {
                sourceText = 'Subject-Specific Knowledge';
            }

            dbTypeInfo.innerHTML = `<small><strong>Source:</strong> ${sourceText}</small>`;
            contextContainer.appendChild(dbTypeInfo);

            context.forEach(item => {
                const contextItem = document.createElement('div');
                contextItem.className = 'context-item';

                const contextSource = document.createElement('div');
                contextSource.className = 'context-source';
                contextSource.innerText = `Source Chunk ${item.index}`;

                const contextContent = document.createElement('div');
                contextContent.className = 'context-content';
                contextContent.innerText = item.content; // Use innerText

                contextItem.appendChild(contextSource);
                contextItem.appendChild(contextContent);
                contextContainer.appendChild(contextItem);
            });
        }

        // Function to send message to the server
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            // Add user message to chat
            addMessage(message, 'user');
            userInput.value = '';

            // Show loading indicator
            showLoading();

            // Send message to the new general endpoint
            fetch('{{ url_for("chat.ask_general_question") }}', { // Use url_for
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    question: message,
                    conversation_id: currentConversationId // Include conversation ID if we have one
                }),
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading();

                    if (data.success) {
                        // Update conversation ID if provided (for new conversations)
                        if (data.conversation_id && !currentConversationId) {
                            currentConversationId = data.conversation_id;
                            // Add header if it wasn't there before
                            if (!document.getElementById('conversation-header')) {
                                const headerDiv = document.createElement('div');
                                headerDiv.id = 'conversation-header';
                                headerDiv.className = 'alert alert-light d-flex justify-content-between align-items-center mb-3';
                                const conversationInfo = document.createElement('div');
                                conversationInfo.innerHTML = `<small>Conversation #${currentConversationId} (General)</small>`;
                                const historyLink = document.createElement('a');
                                historyLink.href = '{{ url_for("chat.general_chat_history_view") }}';
                                historyLink.className = 'btn btn-sm btn-outline-secondary';
                                historyLink.innerHTML = '<i class="fas fa-history"></i> View History';
                                headerDiv.appendChild(conversationInfo);
                                headerDiv.appendChild(historyLink);
                                chatMessages.insertBefore(headerDiv, chatMessages.firstChild);
                            }
                        }

                        // Check for warnings about empty vector databases
                        if (data.warning) {
                            const warningDiv = document.createElement('div');
                            warningDiv.className = 'alert alert-warning mb-3';
                            warningDiv.innerText = data.warning;
                            chatMessages.appendChild(warningDiv);
                        }

                        // Add bot message to chat
                        addMessage(data.answer, 'bot');

                        // Display context
                        displayContext(data.context, data.context_type);
                    } else {
                        // Show error message
                        addMessage(`Error: ${data.error}`, 'bot');
                    }
                })
                .catch(error => {
                    hideLoading();
                    // Show error message
                    addMessage(`Error communicating with the server: ${error}`, 'bot');
                });
        }

        // *** Start: Added PDF Upload Handling ***
        // Function to handle PDF uploads
        function handlePdfUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Check if file is PDF
            if (file.type !== 'application/pdf') {
                addMessage('Only PDF files are supported.', 'bot');
                return;
            }

            // Show uploading message
            addMessage(`Uploading ${file.name}...`, 'user');
            showLoading();

            // Create form data
            const formData = new FormData();
            formData.append('pdf_file', file);

            // Upload file (use the existing endpoint)
            fetch('{{ url_for("chat.upload_pdf") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                credentials: 'same-origin',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading();

                    if (data.success) {
                        addMessage(`Successfully uploaded and processed "${data.filename}". I can now use this document for your questions.`, 'bot');
                    } else {
                        addMessage(`Error uploading file: ${data.error}`, 'bot');
                    }
                })
                .catch(error => {
                    hideLoading();
                    addMessage(`Error uploading file: ${error}`, 'bot');
                });

            // Reset file input
            e.target.value = '';
        }
        // *** End: Added PDF Upload Handling ***

        // Initialize chat when page loads
        initializeChat();

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // *** Start: Added Upload Button Listener ***
        // Initialize PDF upload button if it exists
        if (uploadPdfBtn && pdfUploadInput) {
            uploadPdfBtn.addEventListener('click', function () {
                pdfUploadInput.click();
            });

            pdfUploadInput.addEventListener('change', handlePdfUpload);
        }
        // *** End: Added Upload Button Listener ***

        // Initialize tooltips (for the upload button)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Function to start a new conversation
        function startNewConversation() {
            // Reset conversation ID
            currentConversationId = null;

            // Clear chat messages except for the welcome message
            chatMessages.innerHTML = '';

            // Add welcome message
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'message bot-message';
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerText = "Hello! I'm your Edunext for general university knowledge. How can I help you today?";
            welcomeMessage.appendChild(messageContent);
            chatMessages.appendChild(welcomeMessage);

            // Clear context
            contextContainer.innerHTML = '';

            // Remove conversation header if exists
            const conversationHeader = document.getElementById('conversation-header');
            if (conversationHeader) {
                conversationHeader.remove();
            }

            // Clear input field
            userInput.value = '';
        }

        // Add event listener for new conversation button
        newConversationBtn.addEventListener('click', startNewConversation);

    });
</script>
{% endblock %}